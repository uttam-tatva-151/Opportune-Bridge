
---

# üõ°Ô∏è Refresh Token Table & Device Identification Design

## Overview

This document describes the advanced design and operational logic behind the **Refresh Token** table for secure authentication in a modern .NET backend. Special attention is given to managing device identity and user agent tracking, ensuring robust security and fine-grained session control.

---

### üö© **Why Device ID?**
- **Purpose:** Identifies and manages tokens on a per-device basis.
- **Benefit:** Enables features like "log out from other devices," device-specific security alerts, and session tracking.
- **Implementation:** A unique UUID generated by the frontend (Angular, mobile app, etc.) and sent with every authentication/refresh request.

#### **Frontend Example (Angular)**
```typescript
// Generate/store deviceId once per install/session
const deviceId = localStorage.getItem('deviceId') ?? uuidv4();
localStorage.setItem('deviceId', deviceId);

// Include in every auth request
const headers = new HttpHeaders({ 'X-Device-Id': deviceId });
this.http.post('/api/auth/login', body, { headers });
```

#### **Backend Example (.NET)**
```csharp
var deviceId = Request.Headers["X-Device-Id"].ToString();
```

---

### üïµÔ∏è **Why User Agent?**
- **Purpose:** Captures client software and OS details, which helps in session management and anomaly detection.
- **Benefit:** Allows admins or users to review active sessions (e.g., which device/browser), and can trigger security actions for unknown agents.
- **Implementation:** Automatically sent by browsers in the `User-Agent` header.

#### **Backend Example**
```csharp
var userAgent = Request.Headers["User-Agent"].ToString();
```

---

### üåê **Getting the Client IP Address**

- **Direct (simple server):**
  ```csharp
  var ip = HttpContext.Connection.RemoteIpAddress?.ToString();
  ```
- **Behind Proxy (e.g., NGINX, cloud):**
  ```csharp
  var ip = Request.Headers["X-Forwarded-For"].FirstOrDefault()
           ?? HttpContext.Connection.RemoteIpAddress?.ToString();
  ```

---

## üîê Insert Refresh Token Example (Controller)

```csharp
[HttpPost("login")]
public async Task<IActionResult> Login([FromBody] LoginRequest request)
{
    // ... Authenticate user ...
    var refreshToken = _jwtService.GenerateRefreshToken();
    var deviceId = Request.Headers["X-Device-Id"].ToString();
    var userAgent = Request.Headers["User-Agent"].ToString();
    var ip = Request.Headers["X-Forwarded-For"].FirstOrDefault() 
             ?? HttpContext.Connection.RemoteIpAddress?.ToString();

    // Save to DB (pseudo-call)
    await _refreshTokenService.InsertAsync(new RefreshToken
    {
        UserId = user.Id,
        Token = refreshToken,
        ExpiresAt = DateTime.UtcNow.AddDays(7),
        CreatedAt = DateTime.UtcNow,
        CreatedByIp = ip,
        UserAgent = userAgent,
        DeviceId = deviceId,
        IsActive = true,
        IsRevoked = false
    });

    // Set HttpOnly cookie, return access token (not shown)
}
```

---

## üõ†Ô∏è Best Practices & Security

- **Always** require and validate `DeviceId` for each token operation.
- **Never** trust user agent or IP blindly; use for anomaly detection, not for authentication.
- **Log** all fields for auditing and incident response.
- **Expose** device/session lists to users for transparency and security.

---

## üìã Useful SQL Queries

- **List all active sessions for a user:**
    ```sql
    SELECT device_id, user_agent, created_at, created_by_ip
    FROM refresh_token
    WHERE user_id = :userId AND is_active = TRUE AND is_revoked = FALSE AND expires_at > NOW();
    ```

- **Revoke all tokens for a device:**
    ```sql
    UPDATE refresh_token
    SET is_revoked = TRUE, revoked_at = NOW(), is_active = FALSE
    WHERE user_id = :userId AND device_id = :deviceId AND is_active = TRUE;
    ```

---

## üìé References

- [OWASP: Refresh Token Best Practices](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html)
- [.NET Docs: Accessing Request Headers](https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.http.httprequest.headers)

---

> **Tip:**  
> Use Device ID and User Agent data to show users a "Manage Devices/Sessions" page‚Äîempowering them to revoke suspicious tokens themselves!

---
